pipeline{
    agent any
    tools {
        maven 'maven-3.6.3'
        jdk 'jdk8'
    }

    stages{
        stage('Build'){
            steps {
                echo 'Build started'
                sh 'mvn -f com.riccardomalavolti.apps.todolist/pom.xml clean'
                sh "mvn -f com.riccardomalavolti.apps.todolist/pom.xml compile jacoco:prepare-agent"
                echo '======= Build finished ======='
                }
        }
        stage('Unit Testing'){
            steps{
                echo 'Testing started'
                sh 'export DISPLAY=33'
                wrap([$class: 'Xvfb', additionalOptions: '', assignedLabels: '', autoDisplayName: true, debug: true, displayNameOffset: 33, screen: '1366x768x16']){
                    sh 'mvn -f com.riccardomalavolti.apps.todolist/pom.xml test -Pjacoco,mutation-testing jacoco:report'
                    
                }
                publishCoverage adapters: [jacocoAdapter('**/target/site/jacoco/jacoco.xml')]
                junit '**/target/surefire-reports/*.xml'
                echo 'Ending testing phase'
            }
        }
        
        stage('Integration and E2E testing'){
            steps{
                echo 'Testing started'
                sh 'export DISPLAY=33'
                wrap([$class: 'Xvfb', additionalOptions: '', assignedLabels: '', autoDisplayName: true, debug: true, displayNameOffset: 33, screen: '1366x768x16']){
                    sh 'mvn -f com.riccardomalavolti.apps.todolist/pom.xml verify surefire-report:failsafe-report-only org.apache.maven.plugins:maven-site-plugin:3.7.1:site -DskipSurefire=true'
                }
                junit '**/target/failsafe-reports/*.xml'
                echo 'Ending testing phase'
            }
        }

        stage('Code analysis'){
            steps{
                echo 'Code quality analysis started'
                sh 'mvn -f ./com.riccardomalavolti.apps.todolist/pom.xml coveralls:report sonar:sonar'
                echo 'Code analysis ended.'
            }
        }
    }
}

